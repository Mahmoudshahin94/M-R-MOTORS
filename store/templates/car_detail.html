{% extends 'base.html' %}
{% load static %}

{% block title %}Car Details - M&R Motors{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loading-state" class="flex justify-center items-center py-20">
    <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-secondary-silver">Loading car details...</p>
    </div>
</div>

<!-- Car Not Found State -->
<div id="not-found-state" class="hidden py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="text-6xl mb-6">‚ùå</div>
        <h2 class="text-3xl font-bold text-white mb-4">Car Not Found</h2>
        <p class="text-xl text-secondary-silver mb-8">
            Sorry, we couldn't find the car you're looking for.
        </p>
        <a href="{% url 'inventory' %}" 
           class="inline-block bg-accent-red text-white px-8 py-3 rounded-lg font-semibold hover:bg-red-700">
            Back to Inventory
        </a>
    </div>
</div>

<!-- Car Detail Content -->
<div id="car-content" class="hidden">
    <!-- Car Detail Section -->
    <section class="py-16 bg-primary-black">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Car Image Carousel -->
                <div>
                    <div id="car-image-container" class="relative rounded-lg overflow-hidden border border-gray-800 bg-gray-900">
                        <img id="car-image" src="" alt="" class="w-full h-auto">
                        
                        <!-- Navigation Arrows -->
                        <button id="prev-image" class="hidden absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-75 text-white p-3 rounded-full transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button id="next-image" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-75 text-white p-3 rounded-full transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        
                        <!-- Image Counter -->
                        <div id="image-counter" class="hidden absolute bottom-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
                            <span id="current-image-index">1</span> / <span id="total-images">1</span>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Gallery -->
                    <div id="thumbnail-gallery" class="hidden mt-4 grid grid-cols-4 gap-2">
                        <!-- Thumbnails will be inserted here -->
                    </div>
                </div>
                
                <!-- Car Information -->
                <div>
                    <div id="car-year" class="inline-block bg-accent-red text-white px-4 py-2 rounded-full text-sm font-semibold mb-4"></div>
                    <h1 id="car-title" class="text-4xl md:text-5xl font-bold text-white mb-4"></h1>
                    <p id="car-price" class="text-4xl md:text-5xl font-bold text-accent-red mb-6"></p>
                    
                    <!-- Car Specs -->
                    <div id="car-specs" class="mb-6 space-y-2"></div>
                    
                    <p id="car-description" class="text-lg text-secondary-silver mb-8 leading-relaxed"></p>
                    
                    <!-- WhatsApp Buttons -->
                    <div class="space-y-3">
                        <h3 class="text-xl font-bold text-white mb-3">Contact Us About This Car</h3>
                        <a 
                            id="whatsapp-1"
                            href="#" 
                            target="_blank"
                            class="block w-full bg-green-600 text-white text-center px-6 py-4 rounded-lg text-lg font-semibold hover:bg-green-700 transition-colors"
                        >
                            üì± WhatsApp: (409) 499-8722
                        </a>
                        <a 
                            id="whatsapp-2"
                            href="#" 
                            target="_blank"
                            class="block w-full bg-green-600 text-white text-center px-6 py-4 rounded-lg text-lg font-semibold hover:bg-green-700 transition-colors"
                        >
                            üì± WhatsApp: (254) 450-1993
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    (function() {
        console.log('Car detail script started');
        const carId = '{{ car_id }}';
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCarDetail);
        } else {
            initCarDetail();
        }
        
        function initCarDetail() {
            console.log('Loading car details for ID:', carId);
            loadCarDetails();
        }
        
        function loadCarDetails() {
            fetch('{% url "get_cars_api" %}')
                .then(response => response.json())
                .then(data => {
                    console.log('API data received:', data);
                    document.getElementById('loading-state').classList.add('hidden');
                    
                    // Find the car with matching ID
                    const car = data.cars.find(c => String(c.id) === String(carId));
                    
                    if (!car) {
                        console.log('Car not found');
                        document.getElementById('not-found-state').classList.remove('hidden');
                        return;
                    }
                    
                    console.log('Car found:', car);
                    renderCarDetails(car);
                    document.getElementById('car-content').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading car details:', error);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('not-found-state').classList.remove('hidden');
                });
        }
        
        let currentImageIndex = 0;
        let carImages = [];
        
        function renderCarDetails(car) {
            const price = car.price ? '$' + car.price.toLocaleString() : 'Contact for price';
            const title = car.title || car.car_model || 'Car';
            const year = car.year || '';
            const description = car.description || 'No description available.';
            
            // Get all car images
            carImages = car.images && car.images.length > 0 ? 
                car.images.map(img => img.url) : 
                [car.primary_image || 'https://via.placeholder.com/800x600?text=No+Image'];
            
            // Set car details
            document.getElementById('car-title').textContent = title;
            document.getElementById('car-price').textContent = price;
            document.getElementById('car-description').textContent = description;
            
            if (year) {
                document.getElementById('car-year').textContent = year;
            } else {
                document.getElementById('car-year').classList.add('hidden');
            }
            
            // Add car specs
            var specsHtml = '';
            if (car.mileage) {
                specsHtml += '<div class="flex items-center text-secondary-silver"><span class="font-semibold text-white mr-2">Mileage:</span>' + car.mileage.toLocaleString() + ' miles</div>';
            }
            if (car.condition) {
                specsHtml += '<div class="flex items-center text-secondary-silver"><span class="font-semibold text-white mr-2">Condition:</span>' + car.condition + '</div>';
            }
            if (specsHtml) {
                document.getElementById('car-specs').innerHTML = specsHtml;
            }
            
            // Setup image carousel
            setupImageCarousel(title);
            
            // Set WhatsApp links
            const message = 'Hi, I\'m interested in the ' + title + (year ? ' (' + year + ')' : '');
            const encodedMessage = encodeURIComponent(message);
            document.getElementById('whatsapp-1').href = 'https://wa.me/14094998722?text=' + encodedMessage;
            document.getElementById('whatsapp-2').href = 'https://wa.me/12544501993?text=' + encodedMessage;
            
            // Update page title
            document.title = title + ' - M&R Motors';
            
            console.log('Car details rendered successfully');
        }
        
        function setupImageCarousel(title) {
            const mainImage = document.getElementById('car-image');
            const prevBtn = document.getElementById('prev-image');
            const nextBtn = document.getElementById('next-image');
            const counter = document.getElementById('image-counter');
            const currentIndexEl = document.getElementById('current-image-index');
            const totalImagesEl = document.getElementById('total-images');
            const thumbnailGallery = document.getElementById('thumbnail-gallery');
            
            // Set initial image
            updateImage(0, title);
            
            // Show controls if multiple images
            if (carImages.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                counter.classList.remove('hidden');
                thumbnailGallery.classList.remove('hidden');
                
                totalImagesEl.textContent = carImages.length;
                
                // Create thumbnails
                thumbnailGallery.innerHTML = '';
                carImages.forEach((imageUrl, index) => {
                    const thumb = document.createElement('div');
                    thumb.className = 'cursor-pointer rounded-lg overflow-hidden border-2 transition-all ' + 
                        (index === 0 ? 'border-accent-red' : 'border-gray-800 hover:border-gray-600');
                    thumb.innerHTML = '<img src="' + imageUrl + '" alt="' + title + '" class="w-full h-20 object-cover">';
                    thumb.onclick = () => updateImage(index, title);
                    thumb.dataset.index = index;
                    thumbnailGallery.appendChild(thumb);
                });
                
                // Navigation button handlers
                prevBtn.onclick = () => {
                    currentImageIndex = (currentImageIndex - 1 + carImages.length) % carImages.length;
                    updateImage(currentImageIndex, title);
                };
                
                nextBtn.onclick = () => {
                    currentImageIndex = (currentImageIndex + 1) % carImages.length;
                    updateImage(currentImageIndex, title);
                };
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') prevBtn.click();
                    if (e.key === 'ArrowRight') nextBtn.click();
                });
            } else {
                // Hide controls for single image
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                counter.classList.add('hidden');
                thumbnailGallery.classList.add('hidden');
            }
        }
        
        function updateImage(index, title) {
            currentImageIndex = index;
            const mainImage = document.getElementById('car-image');
            const currentIndexEl = document.getElementById('current-image-index');
            
            mainImage.src = carImages[index];
            mainImage.alt = title;
            currentIndexEl.textContent = index + 1;
            
            // Update thumbnail borders
            const thumbnails = document.querySelectorAll('#thumbnail-gallery > div');
            thumbnails.forEach((thumb, i) => {
                if (i === index) {
                    thumb.className = 'cursor-pointer rounded-lg overflow-hidden border-2 border-accent-red transition-all';
                } else {
                    thumb.className = 'cursor-pointer rounded-lg overflow-hidden border-2 border-gray-800 hover:border-gray-600 transition-all';
                }
            });
        }
    })();
</script>
{% endblock %}
